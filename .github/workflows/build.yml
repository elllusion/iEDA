name: Build and Release

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

# 允许写入 contents（创建 release / 上传资产）
permissions:
  contents: write

jobs:
  build:
    # 使用 GitHub 托管的 Linux runner，但在 Debian 11 容器里执行
    runs-on: ubuntu-22.04
    #container:
    #  image: debian:11

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Debian 11)
        run: |
          sudo sed -i \
          -e 's@//archive.ubuntu.com@//mirrors.tuna.tsinghua.edu.cn@g' \
          -e 's@//security.ubuntu.com@//mirrors.tuna.tsinghua.edu.cn@g' \
          /etc/apt/sources.list
          # 如果 build.sh 需要 sudo，容器内为 root，直接运行即可
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update && sudo apt-get install -y \
          g++-10 cmake ninja-build \
          tcl-dev libgflags-dev libgoogle-glog-dev libboost-all-dev libgtest-dev flex \
          libeigen3-dev libunwind-dev libmetis-dev libgmp-dev bison rustc cargo \
          libhwloc-dev libcairo2-dev libcurl4-openssl-dev libtbb-dev git

      - name: Build
        run: |
          #cd src/database/manager/parser/verilog/verilog-rust/verilog-parser
          #cargo fix --edition
          #cd -
          bash build.sh -j 16

      - name: Package artifacts
        run: |
          mkdir -p release
          # 假设构建输出在 build/ 目录；请根据实际输出调整以下命令
          if [ -d build ]; then
            tar -czf release/iEDA-${{ github.sha }}.tar.gz build
          else
            # 如果没有 build 目录，把 repo 根或自定义产物打包
            tar -czf release/iEDA-${{ github.sha }}.tar.gz .
          fi

     # 生成短 SHA（7 位）并导出为步骤输出，供后续作为 tag 使用
      - name: Set short SHA
        id: vars
        run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # 创建 Release（使用短 SHA 避免 40 字符 hex 被禁止）
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: release-${{ steps.vars.outputs.short_sha }}
          release_name: Release ${{ steps.vars.outputs.short_sha }}
          body: Automated build from ${{ github.ref }} (commit ${{ github.sha }})
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      # 上传 release 资产
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release/iEDA-${{ github.sha }}.tar.gz
          asset_name: iEDA-${{ github.sha }}.tar.gz
          asset_content_type: application/gzip
